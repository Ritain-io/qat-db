---
language: ruby
rvm:
  - 2.5

services:
  - docker

stages:
  - test
  - release

# ORACLE RPM REPO: https://yum.oracle.com/repo/OracleLinux/OL7/oracle/instantclient/x86_64/index.html
before_install:
  - sudo apt-get install alien dpkg-dev debhelper build-essential
  - wget https://yum.oracle.com/repo/OracleLinux/OL7/oracle/instantclient/x86_64/getPackage/oracle-instantclient19.3-basic-19.3.0.0.0-1.x86_64.rpm
  - sudo alien -i oracle-instantclient19.3-basic-19.3.0.0.0-1.x86_64.rpm
  - wget https://yum.oracle.com/repo/OracleLinux/OL7/oracle/instantclient/x86_64/getPackage/oracle-instantclient19.3-devel-19.3.0.0.0-1.x86_64.rpm
  - sudo alien -i oracle-instantclient19.3-devel-19.3.0.0.0-1.x86_64.rpm
  - wget https://yum.oracle.com/repo/OracleLinux/OL7/oracle/instantclient/x86_64/getPackage/oracle-instantclient19.3-sqlplus-19.3.0.0.0-1.x86_64.rpm
  - sudo alien -i oracle-instantclient19.3-sqlplus-19.3.0.0.0-1.x86_64.rpm
  - export LD_LIBRARY_PATH=/usr/lib/oracle/19.3/client64/lib:$LD_LIBRARY_PATH

jobs:
  include:
    - stage: test
      name: "version"
      script: ruby -e "require './lib/qat/db/version'; raise StandardError.new unless Gem::Specification::load('qat-db.gemspec').version.to_s == QAT::DB::VERSION"
      if: tag IS blank

    - name: "documentation"
      script: bundle exec rake qat:devel:validate_yard_doc
      if: tag IS blank

    - name: "static"
      script: bundle exec rake qat:devel:static_analysis:validation
      if: tag IS blank

    - name: "unit tests"
      script:
        - export POSTGRES_DB=qat_db
        - export POSTGRES_USER=test
        - export POSTGRES_PASSWD=t3st
        - export ORACLE_DB=xe
        - export ORACLE_USER=system
        - export ORACLE_PASSWD=oracle
        - docker-compose up -d
        - cat /etc/passwd
        #- echo $POSTGRES_DB $POSTGRES_USER $POSTGRES_PASSWD $ORACLE_DB $ORACLE_USER $ORACLE_PASSWD
        - echo POSTGRES_DB POSTGRES_USER POSTGRES_PASSWD ORACLE_DB ORACLE_USER ORACLE_PASSWD
        #- psql $POSTGRES_DB $POSTGRES_USER
        - psql POSTGRES_DB POSTGRES_USER
        #- bundle exec rake qat:devel:tests:run
      if: tag IS blank

    - name: "gem build"
      script: gem build *.gemspec
      if: tag IS blank

    - stage: release
      name: "gem release"
      script: echo "Deploying to rubygems.org ..."
      deploy:
        provider: rubygems
        api_key: $RUBYGEMS_API_KEY
        gemspec: qat-db.gemspec
        on:
          tags: true
      if: tag IS present